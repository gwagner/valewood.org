<!-- ignore empty links with + -->
{{ $headers := findRE "<h2.*?>(.|\n])+?</h2>" .Content }}
<!-- at least one header to link to -->
{{ $has_headers := ge (len $headers) 1 }}
<!-- a post can explicitly disable Table of Contents with toc: false -->
{{ $show_toc := (eq $.Params.toc true) }}

{{ if and $has_headers $show_toc }}
    <ul>
    {{ range $headers }}
        {{ $header := . }}
        
        {{ $base := ($.Page.File.LogicalName) }}
        {{ $anchorId := ($header | plainify | htmlEscape | urlize) }}
        {{ $href := delimit (slice $base $anchorId) "#" | string }}
    
        <li>
            <a href="{{ relref $.Page $href }}">{{ $header | plainify | htmlEscape }}</a>
        </li>
    
    {{ end }}
    </ul>
{{ end }}