/**
 * 
Remove 
<div class="elementor-toc__spinner-container"> 
    <i class="elementor-toc__spinner eicon-animation-spin eicon-loading" aria-hidden="true"></i>
</div>
 * 

Add
<ol class="elementor-toc__list-wrapper">
    <li class="elementor-toc__list-item">
        <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-0"
                class="elementor-toc__list-item-text elementor-toc__top-level">Definition of DevOps</a></div>
        <ol class="elementor-toc__list-wrapper">
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-1"
                        class="elementor-toc__list-item-text">What DevOps is Not!</a></div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-2"
                        class="elementor-toc__list-item-text">Methodology-Focused Definition of DevOps&nbsp;</a></div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-3"
                        class="elementor-toc__list-item-text">Technology-Focused Definition of DevOps</a></div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-4"
                        class="elementor-toc__list-item-text">Why DevOps and Agile are like Peanut Butter and
                        Chocolate</a></div>
            </li>
        </ol>
    </li>
    <li class="elementor-toc__list-item">
        <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-5"
                class="elementor-toc__list-item-text elementor-toc__top-level">What Business Problems is DevOps
                Solving?</a></div>
        <ol class="elementor-toc__list-wrapper">
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-6"
                        class="elementor-toc__list-item-text">DevOps is Trying to Solve the Consistent Flow of Value</a>
                </div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-7"
                        class="elementor-toc__list-item-text">DevOps is Trying to Solve Visibility and Communication</a>
                </div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-8"
                        class="elementor-toc__list-item-text">DevOps is Trying to Solve Responsibility</a></div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-9"
                        class="elementor-toc__list-item-text">DevOps is trying to solve Operational Inefficiencies</a>
                </div>
            </li>
        </ol>
    </li>
    <li class="elementor-toc__list-item">
        <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-10"
                class="elementor-toc__list-item-text elementor-toc__top-level">What are the Business Benefits of
                Embracing DevOps Methodologies?</a></div>
    </li>
    <li class="elementor-toc__list-item">
        <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-11"
                class="elementor-toc__list-item-text elementor-toc__top-level">What are the Characteristics of a Healthy
                DevOps Culture?</a></div>
    </li>
    <li class="elementor-toc__list-item">
        <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-12"
                class="elementor-toc__list-item-text elementor-toc__top-level">What is DevOps?</a></div>
        <ol class="elementor-toc__list-wrapper">
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-13"
                        class="elementor-toc__list-item-text">Operations Teams</a></div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-14"
                        class="elementor-toc__list-item-text">Infrastucture Teams</a></div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-15"
                        class="elementor-toc__list-item-text">Software Development Teams</a></div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-16"
                        class="elementor-toc__list-item-text">Quality Assurance Teams</a></div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-17"
                        class="elementor-toc__list-item-text">Product Mangement and Product Owners</a></div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-18"
                        class="elementor-toc__list-item-text">Account Management, Business Development, and Client
                        Services Teams</a></div>
            </li>
            <li class="elementor-toc__list-item">
                <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-19"
                        class="elementor-toc__list-item-text">Executive Sponsors</a></div>
            </li>
        </ol>
    </li>
    <li class="elementor-toc__list-item">
        <div class="elementor-toc__list-item-text-wrapper"><a href="#elementor-toc__heading-anchor-20"
                class="elementor-toc__list-item-text elementor-toc__top-level elementor-item-active">Conclusion</a>
        </div>
    </li>
</ol>
 */

import fs from 'fs';
import path from 'path';
import lunr from 'lunr';
import cheerio from 'cheerio';

const HTML_FOLDER = ".";  // folder with your HTML files
const DEPTH = 2;

function findHtml(folder) {
  if (!fs.existsSync(folder)) {
    console.log("Could not find folder: ", folder);
    return;
  }

  var files = fs.readdirSync(folder);
  var htmls = [];
  for (var i = 0; i < files.length; i++) {
    var filename = path.join(folder, files[i]);
    var stat = fs.lstatSync(filename);
    if (stat.isDirectory()) {
      var recursed = findHtml(filename);
      for (var j = 0; j < recursed.length; j++) {
        recursed[j] = path.join(files[i], recursed[j]).replace(/\\/g, "/");
      }
      htmls.push.apply(htmls, recursed);
    }
    else if (isHtml(filename)) {
      htmls.push(files[i]);
    };
  };
  return htmls;
};

function isHtml(filename) {
  var lower = filename.toLowerCase();
  return (lower.endsWith(".htm") || lower.endsWith(".html"));
}

function readHtml(root, file) {
  var filename = path.join(root, file);
  return fs.readFileSync(filename).toString();
}

function addReplacement(id, title, step, tag, replacements) {
  // Skip empty titles
  if(title.trim() == "" || title.trim() == "&nbsp;") {
    return
  }
  var duplicate = 0
  replacements.forEach(function (r) {
    if (r.id == id) {
      duplicate++
    }
  })
  if (duplicate > 0) {
    id = id + "-" + duplicate
  }
  replacements.push({
    'id': id,
    'title': title,
    'step': step,
    'tag': tag
  });

  return;
}

function sanitizeHTag(text) {
  return text.replace(/[^a-zA-Z0-9\s]+/, "").replace(/[\r\n]+/, " ").replace(/[\s]{2,}/, " ").toLowerCase().trim().replace(/\s/g, '-')
}

var files = findHtml(HTML_FOLDER);
for (var i = 0; i < files.length; i++) {
  var filename = files[i];

  var html = readHtml(HTML_FOLDER, filename)
  var $ = cheerio.load(html);

  if ($('.elementor-toc__header').length == 0) {
    continue
  }

  var replacements = [];

  console.log("Modifying file: " + filename)
  $('h2').each(function (idx, tag) {
    if(DEPTH < 1){ return; }
    addReplacement(sanitizeHTag($(tag).html()), $(tag).html(), 0, $(tag), replacements)

    $(tag).nextUntil("h2").filter("h3").each(function (idx, tag) {
      if(DEPTH < 2){ return; }
      addReplacement(sanitizeHTag($(tag).html()), $(tag).html(), 1, $(tag), replacements)

      $(tag).nextUntil("h3").filter("h4").each(function (idx, tag) {
        if(DEPTH < 3){ return; }
        addReplacement(sanitizeHTag($(tag).html()), $(tag).html(), 2, $(tag), replacements)

        $(tag).nextUntil("h4").filter("h5").each(function (idx, tag) {
          if(DEPTH < 4){ return; }
          addReplacement(sanitizeHTag($(tag).html()), $(tag).html(), 3, $(tag), replacements)

          $(tag).nextUntil("h5").filter("h6").each(function (idx, tag) {
            if(DEPTH < 5){ return; }
            addReplacement(sanitizeHTag($(tag).html()), $(tag).html(), 4, $(tag), replacements)

          });
        });
      });
    });
  })
  //  console.log(replacements)

  $('.elementor-toc__spinner-container').remove()
  var currentOrderedList = $("<ol>").attr("class", 'elementor-toc__list-wrapper');
  let parentOrderedList;

  // Get a pointer to the root OL
  var ol = currentOrderedList

  // current depth of the loop
  var depth = 0;

  replacements.forEach(function (item) {
    if (item.step > depth) {
      depth = item.step

      var newOrderedList = $("<ol>").attr("class", 'elementor-toc__list-wrapper')
      currentOrderedList.children().filter('li').last().append(newOrderedList)
      parentOrderedList = currentOrderedList
      currentOrderedList = newOrderedList
    }

    if (item.step < depth) {
      depth = item.step

      currentOrderedList = parentOrderedList
      parentOrderedList = $(currentOrderedList).parent('ol')
    }

    currentOrderedList.append($(`
      <li class=\"elementor-toc__list-item\">
        <div class="elementor-toc__list-item-text-wrapper">
          <a href="#${item.id}" class="elementor-toc__list-item-text elementor-toc__top-level">${item.title}</a>
        </div>
      </li>`))
    item.tag.attr("id", item.id)
  })

  $('.elementor-toc__body').append(ol)

  try{
    fs.writeFileSync(filename, $.html())
    console.log("Table of contents saved: "+filename);
  }catch(err) {
    console.log(err)
    break;
  }
}
